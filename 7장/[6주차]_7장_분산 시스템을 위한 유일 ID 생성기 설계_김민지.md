# 7장 분산 시스템을 위한 유일 ID 생성기 설계
분산 시스템에서 유일성이 보장되는 ID를 만드는 방법은 여러가지이다.

- 다중 마스터 복제
- UUID
- 티켓 서버
- 트위터 스노플레이크 접근법

우리는 요구사항에 따라 적절한 방법을 선택하여 유일 ID 생성기를 설계할 수 있다.

## 다중 마스터 복제
다중 마스터 복제는 데이터베이스의 auto_increment 기능을 활용한다.

다만, 다음 ID를 구할 때 1만큼 증가시키면 서로 다른 데이터베이스 간 충돌이 일어날 수 있기 때문에,

**k(= 데이터베이스 서버의 수)만큼 증가**시켜 다음 ID를 구한다.

- 장점
  - 데이터베이스 수를 늘리면 초당 생산 가능 ID 수를 늘릴 수 있으므로 규모 확장성 문제를 어느 정도 해결한다.
- 단점
  - 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다.
  - ID의 유일성은 보장되겠지만 그 값이 시간 흐름에 맞추어 커지도록 보장할 수 없다.
  - 서버를 추가하거나 삭제할 때도 잘 동작하도록 만들기 어렵다.
 
## UUID
UUID는 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 128비트짜리 수이다.

UUID값은 충돌 가능성이 지극히 낮으며, 서버 간 조율 없이 독립적으로 생성 가능하다. 

- 장점
  - UUID를 만드는 것은 단순하다.(동기화 이슈 X)
  - 각 서버가 자기가 쓸 ID를 알아서 만드는 구조이므로 규모 확장이 쉽다.
- 단점
  - ID가 128비트로 길다.
  - ID를 시간순으로 정렬할 수 없다.
  - ID에 숫자가 아닌 값이 포함될 수 있다.
 
## 티켓 서버
티켓 서버(ticket server)는 auto_increment 기능을 갖춘 데이터베이스 서버(= 티켓 서버)를 중앙 집중형으로 하나만 사용하는 것이다.

- 장점
  - 유일성이 보장되는 오직 숫자로만 구성된 ID를 쉽게 만들 수 있다.
  - 구현하기 쉽고, 중소 규모 애플리케이션에 적합하다.
- 단점
  - 티켓 서버가 SPOF가 된다. 이 이슈를 피하려면 티켓 서버를 여러 대 준비해야 하는데, 그렇게 되면 데이터 동기화 같은 새로운 문제가 발생한다.
 
## 트위터 스노플레이크 접근법
트위터는 스노플레이크(snowflake)라고 부르는 독창적인 ID 생성 기법을 사용한다.

생성해야 하는 ID의 구조를 여러 섹션으로 분할하는 방법이다.

예를 들어, 64비트 ID를 만든다고 하면, 왼쪽부터 다음과 같이 비트를 할당한다.

- 1비트: 사인 비트
- 41비트: 타입스탬프로, 기원 시각 이후로 몇 밀리초가 경과했는지 나타내는 값이다. (약 69년 동안만 정상 작동)
- 5비트: 데이터센터 ID로, 32개의 데이터센터를 지원할 수 있다.
- 5비트: 서버 ID로, 데이터센터 당 32개의 서버를 사용할 수 있다.
- 12비트: 일련번호로, 각 서버가 동일 시각(= 밀리초)에 4096개의 ID를 생성할 수 있다.

## 더 생각해 볼 것
### 시계 동기화
우리는 앞선 ID 생성기들이 전부 같은 시계를 사용한다고 가정하였다.

하지만 이런 가정은 하나의 서버가 여러 코어에서 실행될 경우 유효하지 않을 수 있따.

여러 서버가 물리적으로 독립된 여러 장비에서 실행되는 경우도 마찬가지이다.

이런 문제를 해결하는 보편적인 방법은 NTP(Network Time Protocol)이다.

#### NTP (Network Time Protocol)
인터넷에서 라우터 및 기타 하드웨어 디바이스의 클럭을 동기화하는 데 널리 사용되는 프로토콜이다.

기본 NTP 서버는 UTC(Coordinated Universal Time)에 직접 추적할 수 있는 참조 클럭에 동기화된다.

https://www.juniper.net/documentation/kr/ko/software/junos/time-mgmt/topics/topic-map/network-time-protocol.html
https://guslabview.tistory.com/452

### 각 섹션의 길이 최적화
스노플레이크 접근법에서 동시성이 낮고 수명이 긴 애플리케이션의 경우에는 일련번호 섹션의 길이를 줄이고,

타임스탬프 섹션의 길이를 늘리는 것이 효과적일 수 있다.

### 고가용성
ID 생성기는 필수 불가결 컴포넌트이므로 아주 높은 가용성을 제공해야 한다.

