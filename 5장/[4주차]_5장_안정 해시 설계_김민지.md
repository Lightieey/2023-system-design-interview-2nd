# 5장 안정 해시 설계
<br><br>

## 안정 해시 설계가 필요한 이유?

N개의 캐시 서버에 부하를 균등하게 나누기 위해서 보편적으로 해시 함수를 사용한다.

`serverIndex = hash(key) % N (N: 서버 개수)`

이 방법은 서버 풀의 크기가 고정되어 있을 때, 그리고 데이터 분포가 균등할 때는 잘 동작한다.

하지만 서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다.

예를 들어, 하나의 서버가 장애로 인해 중단되어 서버 풀의 크기가 4에서 3으로 줄었다고 해보자.

서버 풀의 개수인 N이 줄어 %연산의 결과인 서버 인덱스 값이 변하게 된다.

그러면 장애가 발생한 서버에 저장되어 있던 값 뿐만 아니라 대부분의 키가 재분배된다.

그 결과로 캐시 클라이언트가 데이터가 없는 엉뚱한 서버에 접속하게 되어 **대규모 캐시 미스**가 발생하게 될 것이다.
<br><br>

## 안정 해시란

안정해시는 해시 테이블 크기가 조정될 때 평균적으로 k/n개의 키만 재배치하는 해시 기술이다. (k: 키의 개수, n: 슬롯 개수)

`k / n` = `전체 키 개수 / 서버 개수` = `하나의 서버에 배치되어있던 키 개수만큼만 재배치`
<br><br>

### 동작 원리

[ **기본 개념 ]**

해시 함수로 SHA-1을 사용한다고 가정 (%연산을 사용하는 함수가 아님에 유의!)

- 해시 공간: 가능한 해시 출력값의 범위 (ex. 0 ~ 2^160-1)
- 해시 링: 직선 형태의 해시 공간 양쪽을 구부려 접은 형태 ← 안정 해시에서는 요 모양을 사용한다
- 해시 서버: 서버 IP나 이름을 해시 링 위에 배치
- 해시 키: 해시 링 위의 어느 지점에 배치
- 서버 조회: 키는 해시 링에서 시계 방향으로 탐색했을 때 처음 만나는 서버에 저장된다

✔️ 서버가 추가되었을 때

- 추가된 서버의 반시계 방향에서 첫 번째에 있는 서버부터 - 추가된 서버까지의 키만 재배치

✔️서버가 제거되었을 때

- 삭제된 서버의 반시계 방향에서 첫 번째에 있는 서버부터 - 삭제된 서버까지의 키만 재배치

<br><br>
**[ 기본 구현법의 문제점 ]**

1. 파티션의 크기를 균등하게 유지하는 것이 불가능하다. (서버가 추가/삭제되는 과정에서)
2. 키의 균등 분포를 달성하기 어렵다. (hotspot 문제)

이를 해결하기 위해 **가상노드** 개념을 도입한다.

실제 서버를 여러 개의 가상 노드로 나누어 해시 링 위에 분산시켜 배치하는 방법을 사용한다.

이렇게 되면 각 서버는 여러 개의 파티션을 관리하게 된다. 

가상 서버의 개수를 늘리면 키의 분포는 점점 더 균등해지는데, 표준편차가 작아져서 데이터가 고르게 분포되기 때문이다.

(가상 노드가 100~200개인 경우 표준편차는 평균의 5%~10%)

반면 가상 노드의 데이터를 저장할 공간이 더 많이 필요하게 되어 trade off 관계를 가진다.
<br><br>

## 안정 해시의 이점

- 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다
- 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다
- 핫스팟 키 문제를 줄인다

<br><br>
---
<br><br>

### +) Apache Cassandra에서 클러스터에 데이터를 분산하는 방식

해시 링에서 노드의 개수보다 더 많은 파티션을 두고, 여러 노드에 동일 파티션을 복제 저장하는 방식을 사용함.

(아래 그림의 경우 복제 인수가 3임)

- 가상노드를 사용하지 않는 경우: 각 노드는 연속된 파티션 범위를 가짐
- 가상노드를 사용하는 경우: 각 노드는 무작위로 선택된 파티션을 가짐

<img width="628" alt="Screenshot 2023-09-10 at 8 19 50 PM" src="https://github.com/Lightieey/2023-system-design-interview-2nd/assets/79203421/c1a8f734-c13a-42d4-a968-80120a1883de">

[How data is distributed across a cluster (using virtual nodes)](https://docs.datastax.com/en/cassandra-oss/2.2/cassandra/architecture/archDataDistributeDistribute.html)
