# 8장 URL 단축기 설계
URL 단축기를 설계하기 위해서는 다음의 3가지를 이해할 필요가 있다.

## API 엔드포인트
URL 단축기는 기본적으로 두 개의 엔드포인트를 필요로 한다.
1. URL 단축용 엔드포인트
   - ex) POST /api/v1/data/shorten
     - body: {longUrl: longURLstring}
     - response: shorten url
2. URL 리디렉션용 엔드포인트
   - ex) GET /api/v1/shortUrl
     - response: 원래 url

## URL 리디렉션
단축 URL을 받은 서버는 그 URL을 원래 URL로 바꾸어서 301 응답의 Location 헤더에 넣어 반환한다.

### 통신 절차 예시
- 클라이언트 -> 단축 URL 방문 -> tinyurl 서버
- tinyurl 서버 -> 상태코드: 301, Location: 원래 URL -> 클라이언트
- 클라이언트 -> 원래 URL 방문 -> Amazon 서버

### 301 응답과 302 응답의 차이
- 301 Permanently Moved: 해당 URL에 대한 HTTP 요청의 처리 책임이 영구적으로 Location 헤더에 반환된 URL로 이전되었다는 응답이다. 따라서 브라우저는 이 응답을 캐시해두고 사용한다.
- 302 Found: 주어진 URL로의 요청이 일시적으로 Location 헤더가 지정하는 URL에 의해 처리되어야 한다는 응답이다. 따라서 클라이언트는 언제나 단축 URL 서버에 먼저 요청을 보내고 이후 원래 URL로 리디렉션 된다.

  서버 부하를 줄이는 것이 중요하다면 301을, 트래픽 분석이 중요할 때는 302를 쓰는 것이 좋다.

## URL 단축
### 해시 함수
해시 함수는 원래 URL을 단축 URL로 변환하는 데 쓰인다.

해당 장에서는 0-9, a-z, A-Z로 구성된 단축 URL을 3650억개 이상 만드는 것이 목표이므로

3종류 문자들의 개수인 62개를 7자리로 구성하면 3.5개의 URL을 만들 수 있어 단축 URL의 길이를 7로 설정한다.

해시 함수 구현으로는 다음 2가지 방법을 살펴본다.

#### 해시 후 충돌 해소
CRC32, MD5, SHA-1 같이 잘 알려진 해시 함수를 이용해 URL을 축약한다. 

이렇게 되면 우리가 설정한 7자리 수보다 긴 해시값이 나오므로, 우리는 여기서 처음 7개의 글자만 사용하는 방법을 채택할 수 있다.

앞 7자리가 같아 해시 값이 충돌하는 경우에는 충돌이 해소될 때까지 사전에 정한 문자열을 해시값에 덧붙이는 방식으로 충돌을 해결할 수 있다.

#### base-62 변환
진법 변환은 URL 단축기를 구현할 때 흔히 사용되는 접근법 중 하나이다.

해당 장에서 정의한 문제에서는 사용할 수 있는 문자 개수가 62개이기 때문에, 62진법을 사용하면 된다.

## URL 단축기 상세 설계
1. 입력으로 긴 URL을 받는다.
2. 데이터베이스에 해당 URL이 있는지 검사한다.
3. 데이터베이스에 있다면 해당 단축 URL을 가져와서 클라이언트에게 반환한다.
4. 데이터베이스에 없는 경우에는 유일한 ID를 생성해 데이터베이스의 기본 키로 사용한다.
5. 62진법 변환을 적용해 ID를 단축 URL로 만든다.
6. ID, 단축 URL, 원래 URL로 새 데이터베이스 레코드를 만든 후 단축 URL을 클라이언트에게 전달한다.

포인트는 원래 URL이 아닌 **유일 ID를** 62진법 변환을 적용해 단축 URL로 만든다는 것이다.

이 설계에 캐시를 붙여 성능을 높일 수 있다. 

