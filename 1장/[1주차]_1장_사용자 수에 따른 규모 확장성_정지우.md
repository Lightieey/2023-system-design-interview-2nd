#### ✨수백만 사용자를 지원하는 시스템의 설계✨

단일 서버: 웹, 앱, 데이터베이스, 캐시 등이 서버 한 대에서 구동되는 시스템

▶️ 늘어나는 사용자에 따라 서버 확장이 필요 ▶️ 웹/모바일 트래픽을 처리하는 **웹 계층 서버와 데이터베이스 서버를 분리**하여 확장

<img src="https://github.com/aws-cloud-clubs/2023-system-design-interview-2nd/assets/70079416/53adf9ba-8696-432e-a70e-e868d722a2b6" width=60% height=60%>

<br />

## 관계형 vs 비관계형 데이터베이스

비관계형 데이터베이스(NoSQL)는 일반적으로 조인 연산을 지원하지 않는다.

대부분 관계형 데이터베이스(RDBMS)를 사용하는데 다음과 같은 경우에는 비관계형 데이터베이스가 바람직하다.

- 아주 낮은 응답 지연시간이 요구되는 경우
- 비정형 데이터를 다루는 경우
- 데이터를 직렬화/역직렬화할 수 있는 경우
- 저장할 데이터 양이 아주 많은 경우

### 스케일 업 vs 스케일 다운

📍**스케일 업(scale up)**, ****수직적 규모 확장

- **서버로 유입되는 트래픽 양이 적을 때** 좋은 선택
- 서버에 더 좋은 CPU, 더 많은 RAM 등의 **고사양 자원을 추가하는 것**을 의미한다.

그러나 장애에 대한 자동복구(failover)나 다중화(redundancy)를 지원하지 않는다.

서버에 장애 발생 시, 웹/앱은 완전히 중단된다.

📍**스케일 다운(scale down)**, 수평적 규모 확장

- **더 많은 서버를 추가**하여 성능을 개선하는 것으로, 대규모 애플리케이션에 적절하다.

<br />

#### 👀 사용자가 많아져 서버가 한계에 도달하고 응답 속도가 느려지거나 서버 접속이 불가해지는 상황에 적절한 조치는 🌟**로드밸런서 도입🌟**이다

<br />

## 로드밸런서

로드밸런서는 부하 분산 집합에 속한 웹 서버들에게 **트래픽 부하를 고르게 분산**한다.

- 사용자는 로드밸런서의 공개 IP 주소로 접속하고, 로드밸런서는 사설 IP 주소를 이용하여 웹 서버와 통신한다.
- 웹 서버를 추가하면 장애 자동복구 문제가 해소되고, 로드밸런서는 자동으로 트래픽을 분산하며 웹 계층의 가용성(availability)은 높아진다.

<br />

## 데이터베이스의 다중화

- 데이터 원본을 저장하는 주 서버, 사본을 저장하는 부 서버와 같이, RDBMS는 서버 사이에 **주(master)-부(slave) 관계를 설정하는 다중화**를 지원한다.
- 쓰기 연산은 마스터(주 DB 서버)에서만 지원한다.
- 데이터베이스를 변경하는 명령어(`INSERT`, `DELETE`, `UPDATE`)는 주 데이터베이스로만 전달되어야 한다.
- 읽기 연산이 보통 더 많기 때문에 부 데이터베이스가 더 많다.

**데이터베이스 다중화의 장점**은

1. 병렬 처리 가능한 쿼리 수가 늘어 성능이 좋아진다.
2. 안정성 보장. 데이터를 여러 장소에 다중화시키면 서버가 일부 파괴되어도 데이터는 보존된다.
3. 가용성 보장. 하나의 DB 서버에 장애가 생겨도 데이터를 가져올 다른 DB 서버가 존재하므로 계속 서비스할 수 있다.

- 부 서버가 다운되면 주 서버가 임시적으로 읽기 연산을 맡고, 즉시 새로운 부 서버가 장애 서버를 대체한다.
- 주 서버가 다운되면 한 대의 부 서버가 새로운 주 서버가 되고, 모든 연산은 임시적으로 주 서버에서 수행된다.

<br />

## 캐시(Cache); 응답 시간의 개선
- 캐시를 붙이고 정적 콘텐츠를 CDN으로 옮기면 응답시간을 개선할 수 있다.
- 캐시 계층은 데이터가 잠시 보관되는 곳으로, **데이터베이스보다 훨씬 빠르다**.
- 데이터베이스의 부하를 줄여 성능을 개선, 캐시의 규모를 독립적으로 확장시킬 수 있다.
- 캐시에 저장되어 있는 데이터는 캐시에서 읽고, 없는 데이터는 데이터베이스에서 해당 데이터를 읽어 캐시에 쓴 뒤 웹 서버에 데이터를 반환하는 구조로 캐시 서버를 이용한다.

### 캐시를 언제 사용하는가

- 데이터 갱신은 빈번하지 않지만, **데이터 참조가 빈번하게 발생**하는 경우
- 캐시는 휘발성 메모리이므로 중요 데이터는 지속적 저장소에 보관해야 한다
- 캐시에 보관된 데이터에 대한 만료 정책(TTL) 필요
- 데이터 저장소의 원본 데이터와 캐시의 사본 데이터가 동일한지 그 일관성 여부를 고려해야 한다
- SPOF를 피하려면 여러 지역에 걸쳐 캐시 서버를 분산시켜야 한다
- 캐시 메모리를 과할당하여 데이터량이 급증할 시 발생 가능한 문제를 방지한다
- 데이터 방출 정책(LRU, LFU, FIFO)을 적절히 사용

<br />

## CDN(Contents Delivery Network)

> 정적 콘텐츠를 전송하는 데 쓰이는, 지리적으로 분산된 서버의 네트워크
> 
- 특정 사용자가 웹사이트에 방문할 시, 그 사용자에게 가장 가까운 CDN 서버가 정적 콘텐츠를 전달
    
    → 웹 사이트 로딩 시간을 개선할 수 있다!
    

CDN의 캐시 기능을 활용하여 정적 콘텐츠를 **웹 서버가 아닌 CDN을 통해** 제공 → 성능 향상을 보장

<img src="https://github.com/aws-cloud-clubs/2023-system-design-interview-2nd/assets/70079416/f07ba576-b4c4-40d6-a0d6-66c4769a95ab" width=60% height=60%>

<br />

## 무상태(stateless) 웹 계층

웹 계층을 어떻게 수평적으로 활장할 수 있을까?
***→ 상태 정보(session data)를 웹 계층에서 제거하자!***

**상태 정보 의존적인 아키텍처**의 문제점

1. 같은 클라이언트의 요청은 항상 같은 서버로 전송되어야 한다.
2. 이를 지원하는 로드밸런서의 고정 세션(sticky session) 기능은 로드밸런서에 부담을 준다.
3. 서버 추가와 제거가 까다롭다

### 무상태 아키텍처의 등장 !

- 상태 정보는 웹 서버로부터 물리적으로 분리되어 공유 저장소에서 가져온다 ⇒ 구조의 단순화, 안정적, 확장성 보장

<img src="https://github.com/aws-cloud-clubs/2023-system-design-interview-2nd/assets/70079416/289e98a6-d317-4a27-9bda-de935c67beb4" width=60% height=60%>

<br />

#### 상태 정보와 웹 서버를 분리했을 때의 장점?
: 트래픽에 따른 웹 서버의 추가와 제거가 자유로워 규모의 확장성이 쉬워진다.

<br />

## 데이터 센터; 지리적으로 가까운 데이터 센터에 연결하는 전략

지리적 라우팅?
**geoDNS**: 사용자의 위치에 따라 도메인 이름을 어떤 IP 주소로 변환할지 결정하는 DNS 서비스
- 하나의 데이터 센터에 장애가 발생할 시, 다른 데이터 센터로 모든 트래픽이 전송

<img src="https://github.com/aws-cloud-clubs/2023-system-design-interview-2nd/assets/70079416/2143b3e5-647d-4401-bf4e-9ab76365e4ce" width=60% height=60%>

<br />

## 메시지 큐; 더 큰 규모로 확장하기 위한 전략

- **메시지의 무손실**을 보장하는, 비동기 통신 지원 컴포넌트 
- 서버 간 느슨한 결합(decoupling)으로, 규모 확장성이 보장되어야 하는 안정적 애플리케이션에 적합
- 생산자와 소비자는 각기 **독립적인 확장이 가능**하다
    - 생산자 → 소비자 프로세스가 다운되어도 메시지 발행
    - 소비자 → 생산자 서비스가 가용 상태가 아니어도 메시지 수신

<img src="https://github.com/aws-cloud-clubs/2023-system-design-interview-2nd/assets/70079416/21b14ab2-c9ef-425b-a185-34652b643c1d" width=60% height=60%>

<br />

## 로그, 메트릭, 자동화

> *필수는 아니지만, 사업 규모가 큰 서비스를 운영할 경우에 유용*
> 
- 로그 : 에러 로그 모니터링
- 메트릭 : 사업 현황에 관한 유용한 정보 수집
- 자동화: 시스템이 복잡해질 경우, 생산성을 높이기 위한 도구 e.g. CI, 빌드, 테스트, 배포 등의 절차 자동화

### 최종 아키텍처

<img src="https://github.com/aws-cloud-clubs/2023-system-design-interview-2nd/assets/70079416/a1cd2aeb-9510-44dd-9d0b-122014fad72f" width=60% height=60%>

<br />

## 데이터베이스의 규모 확장; 샤딩

수직적 확장: 서버의 CPU, RAM 등을 증설하는 방법으로, 한 대의 서버로 버티는 건 결국 한계가 있다.

- SPOF 위험성↑ & 비용↑

### 수평적 확장 ; a.k.a 샤딩(sharding)

- 더 많은 서버를 추가하여 성능을 향상시키는 방법

❓ **샤딩?** 대규모 데이터베이스를 샤드(shard)라 일컫는 작은 단위로 분할하는 기술

- 모든 샤드는 같은 스키마를 사용하지만, 샤드에 보관되는 데이터 사이에는 중복이 없다.

### 샤딩 전략의 포인트; 샤딩 키(sharding key)를 어떻게 정하느냐

**✨ 데이터를 고르게 분할할 수 있도록 하는 것이 가장 중요하다**

- 데이터의 재샤딩(resharding)
    - 데이터가 많아져서 하나의 샤드로 감당되지 않을 경우
    - 샤드 간 데이터 분포가 균등하지 못하여 공간 소모 속도가 달리 진행될 때 (샤드 소진; shard exhaustion)
- 유명인사(celebrity) 문제
    - 특정 샤드에 질의가 집중되어 서버에 과부하가 걸리는 이슈
- 조인과 비정규화
    - 여러 샤드에 걸친 데이터를 조인하기 어려우므로 데이터베이스의 비정규화가 필요하다