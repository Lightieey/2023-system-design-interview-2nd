# 10장 알림 시스템 설계

## 알림 시스템 종류

### 모바일 푸시 알림

- **iOS 푸시 알림**
    
    알림 제공자 → APNS(Apple Push Notification Service) → iOS 단말
    
- **안드로이드 푸시 알림**
    
    알림 제공자 → FCM(Firebase Cloud Messaging) → 안드로이드 단말
    

### SMS 메시지

보통 트윌리오(Twilio), 넥스모(Nexmo) 같은 서드파티 서비스를 많이 이용한다. 

- 알림 제공자 → SMS 서비스 → SMS 수신 단말

### 이메일

대부분의 회사는 고유 이메일 서버를 구축할 역량을 갖고 있다. 그럼에도 많은 회사가 상용 이메일 서비스를 이용한다. 유명한 서비스로는 센드그리드(Sendgrid), 메일침프(MailChimp)가 있다.

- 알림 제공자 → 이메일 서비스 → 이메일 수신 단말

## 알림 시스템 설계

### 개략적 설계안

개략적으로 아래와 같이 설계할 수 있다.

- N개의 서비스 → 알림 시스템 → 서드파티 알림 제공 서비스 → 사용자 단말

여기서 알림 시스템의 SPOF 문제와 규모 확장성, 성능 병목을 해결하기 위해 다음과 같이 개선시킨다.

- N개의 서비스 → 알림서버(AutoScaling) - 캐시 - DB → 알림 종류별 별도의 큐 → 알림 종류별 별도의 작업 서버 → 알림 종류별 서드파티 서비스 → 사용자 단말
    - 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리한다.
    - 알림 서버는 자동 수평적 규모 확장이 이루어질 수 있도록 한다.
    - 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다.

### 상세 설계

- **안정성**
    1. 데이터 손실 방지
        
        알림 데이터를 데이터베이스(ex. 알림 로그 유)에 보관하고 재시도 메커니즘을 구현한다.
        
    2. 알림 중복 전송 방지
        
        분산 시스템의 특성상 가끔은 같은 알림이 중복되어 전송될 수 있다. 이 빈도를 줄이기 위해 중복을 탐지하는 메커니즘을 도입할 수 있다. 예를 들면, 알림이 도착하면 이벤트 ID를 검사하여 중복 이벤트인지 확인하는 로직을 추가할 수 있다.
        
- **추가 고려사항**
    1. 알림 템플릿
        
        알림 메시지 대부분은 형식이 비슷하므로, 알림 템플릿을 만들어 인자나 스타일, 추적 링크들만 조정해 알림을 쉽게 만들 수 있게 할 수 있다.
        
    2. 알림 설정
        
        사용자가 알림 설정을 상세히 조정할 수 있도록 한다. 이러한 설정을 도입한 뒤 특정 종류의 알림을 보내기 전에 해당 사용자가 해당 알림을 켜 두었는지 확인하는 로직을 추가한다.
        
    3. 전송률 제한
        
        한 사용자가 받을 수 있는 알림의 빈도를 제한하여 과도한 알림으로 사용자가 알림 기능을 꺼 버리는 상황을 방지할 수 있다.
        
    4. 재시도 방법
        
        서드파티 서비스가 알림 전송에 실패하면 해당 알림을 재시도 전용 큐에 넣어 관리한다. 같은 문제가 계속 발생하면 개발자에게 알린다.
        
    5. 푸시알림과 보안
        
        iOS와 안드로이드 앱의 경우 알림 전송 API는 appKey와 appSecret을 사용해 보안을 유지한다. 따라서 인증된, 혹은 승인된 클라이언트만 해당 API를 사용해 알림을 보낼 수 있도록 한다.
        
    6. 큐 모니터링
        
        큐에 쌓인 알림의 개수를 모니터링해 작업 서버들이 이벤트를 빠르게 처리하고 있는지 추적한다.
        
    7. 이벤트 추적
        
        알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭을 분석한다.
